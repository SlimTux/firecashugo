<!DOCTYPE html>
<html class="dark">
  <head>
    <meta charset="utf-8">
    <title>Realtime GeoQueries with Firestore</title>
    <link rel="shortcut icon" href="/img/favicon.png" type="image/x-icon">
    <link rel="stylesheet" href="/svelte/index.80f33729.css" />
    <script type="module" defer src="/svelte/index.593cd389.js" /></script>

    
    <link rel="shortcut icon" href="/img/favicon.png" type="image/x-icon">
    <link rel="apple-touch-icon" type="image/x-icon" href="/img/favicon.png" />
    <meta name="theme-color" content="#454e56">
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <link rel="manifest" href="/manifest.json">
    


    
 




    <link rel="canonical" href="https://fireship.io/lessons/geolocation-query-in-firestore-realtime/" />

    <meta name="description" content="Perform geospatial queries in Firestore based on a radius and visualize realtime updates with Angular Google Maps">
    <meta name="image" content="https://fireship.io/img/default-cover.png">

    <meta property="og:title" content="Realtime GeoQueries with Firestore" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://fireship.io/lessons/geolocation-query-in-firestore-realtime/" />
    <meta property="og:image" content="https://fireship.io/img/default-cover.png" />
    <meta property="og:description" content="Perform geospatial queries in Firestore based on a radius and visualize realtime updates with Angular Google Maps" />

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@fireship_dev">
    <meta name="twitter:title" content="Realtime GeoQueries with Firestore">
    <meta name="twitter:description" content="Perform geospatial queries in Firestore based on a radius and visualize realtime updates with Angular Google Maps">
    <meta name="twitter:image" content="https://fireship.io/img/default-cover.png">
    
    <script>
      if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
              navigator.serviceWorker.register('/sw.js');
          });
      }
    </script>

  </head>
  <body>
    <global-data 
    permalink="https://fireship.io/lessons/geolocation-query-in-firestore-realtime/" 
    vimeo=""
    youtube="lO1S-FAcZU8"
    free=""
    next="https://fireship.io/lessons/auto-save-reactive-forms-with-firestore/" 
    prev="https://fireship.io/lessons/saas-metered-subscriptions-with-stripe-billing-and-firebase/">
  </global-data>

    
<nav class="flex justify-between container p-6 md:p-8">
  <a
    class="flex justify-center items-center text-center w-12 h-12 logo-gif"
    href="/"
  >
    <img id="logo" src="/img/logo.svg" alt="logo" />
    <img class="relative bottom-1 left-1" id="logoBg" src="/img/fire.gif" alt="fire background" />
  </a>

  <ul class="flex justify-center items-center">
    <if-pro>
      <li slot="basic" class="mx-2 md:mx-4  hover:scale-105 transition-transform">
        <a href="/pro" class="font-display text-base font-normal text-green-500 border-green-400 border rounded-md px-2 py-1 hover:drop-shadow-[0_0_9px_rgba(34,197,94,0.9)]">PRO</a>
      </li>
    </if-pro>
    <li class="mx-2 md:mx-4 hover:scale-105 transition-transform">
      <a href="/lessons" class="font-sans text-xl font-bold leading-none text-gray2 hover:text-white">Resources</a>
    </li>
    <li class="mx-2 md:mx-4  hover:scale-105 transition-transform">
      <a href="/courses" class="font-sans text-xl font-bold leading-none text-gray2 gradient-slide">Activities</a>
    </li>
    <li class="ml-2">
      <modal-action type="open" name="search">
        <button class="p-2 mr-2 hidden md:flex justify-between items-center bg-white bg-opacity-10 hover:bg-opacity-20 border border-gray4 hover:border-purple-500 
                 shadow-xl hover:drop-shadow-[0_0_7px_rgba(168,85,247,0.5)] transition-all">
          <span class="text-gray2 w-4 mx-2">
<svg aria-hidden="true" focusable="false" data-prefix="fad" data-icon="search" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="svg-inline--fa fk-search fk-w-16 fk-9x">
<g class="fk-group"><path fill="currentColor" d="M208 80a128 128 0 1 1-90.51 37.49A127.15 127.15 0 0 1 208 80m0-80C93.12 0 0 93.12 0 208s93.12 208 208 208 208-93.12 208-208S322.88 0 208 0z" class="fk-secondary"></path><path fill="currentColor" d="M504.9 476.7L476.6 505a23.9 23.9 0 0 1-33.9 0L343 405.3a24 24 0 0 1-7-17V372l36-36h16.3a24 24 0 0 1 17 7l99.7 99.7a24.11 24.11 0 0 1-.1 34z" class="fk-primary">
</path></g></svg></span>
          <span class="mr-12">Search</span>
          <span class="mx-2 text-xs border border-gray4 rounded-md p-1 px-2">/</span>
        </button>
        <button class="flex md:hidden">
          <span class="text-gray2 w-6 mx-2">
<svg aria-hidden="true" focusable="false" data-prefix="fad" data-icon="search" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="svg-inline--fa fk-search fk-w-16 fk-9x">
<g class="fk-group"><path fill="currentColor" d="M208 80a128 128 0 1 1-90.51 37.49A127.15 127.15 0 0 1 208 80m0-80C93.12 0 0 93.12 0 208s93.12 208 208 208 208-93.12 208-208S322.88 0 208 0z" class="fk-secondary"></path><path fill="currentColor" d="M504.9 476.7L476.6 505a23.9 23.9 0 0 1-33.9 0L343 405.3a24 24 0 0 1-7-17V372l36-36h16.3a24 24 0 0 1 17 7l99.7 99.7a24.11 24.11 0 0 1-.1 34z" class="fk-primary">
</path></g></svg></span>
        </button>
        </modal-action>
      </li>
    <li class="ml-2 mr-6 relative">
      <if-user>
        <a href="/dashboard">
          <user-avatar></user-avatar>
        </a>
        <modal-action slot="signed-out" name="signin" type="open">
          <button class="relative hidden md:inline-block px-4 py-2 text-xl font-display text-black hover:text-white bg-white 
                hover:bg-purple-600 drop-shadow-[6px_6px_0_black] hover:drop-shadow-[0_0_7px_rgba(168,85,247,0.5)] transition-all duration-300">
            login
          </button>
          <button class="flex md:hidden">
            <span class="text-gray2 w-6 mx-2"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M352 96h64c17.7 0 32 14.3 32 32V384c0 17.7-14.3 32-32 32H352c-17.7 0-32 14.3-32 32s14.3 32 32 32h64c53 0 96-43 96-96V128c0-53-43-96-96-96H352c-17.7 0-32 14.3-32 32s14.3 32 32 32zm-7.5 177.4c4.8-4.5 7.5-10.8 7.5-17.4s-2.7-12.9-7.5-17.4l-144-136c-7-6.6-17.2-8.4-26-4.6s-14.5 12.5-14.5 22v72H32c-17.7 0-32 14.3-32 32v64c0 17.7 14.3 32 32 32H160v72c0 9.6 5.7 18.2 14.5 22s19 2 26-4.6l144-136z"/></svg>
</span>
          </button>
        </modal-action>
      </if-user>
    </li>


  </ul>
</nav>


    
<main class="container">


	<div class="flex w-full justify-between">


		<article itemscope itemtype="http://schema.org/Article" class="w-full">
			<meta itemprop="datePublished" content="2018-07-10 05:59:29 -0700 -0700" />
			<meta itemprop="dateModified" content="2019-12-11 05:30:10 -0700 -0700" />
			<meta itemprop="image" content="img/featured.png" />
			<meta itemprop="publisher" content="fireship.io" />


			<header>

				
				
				<div itemprop="video" itemscope itemtype="http://schema.org/VideoObject">
					<iframe class="w-full aspect-video" src="https://www.youtube.com/embed/lO1S-FAcZU8"
						frameborder="0"
						allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
						allowfullscreen></iframe>

					<meta itemprop="embedUrl" content="https://www.youtube.com/embed/lO1S-FAcZU8" />
					<meta itemprop="thumbnailUrl" content="" />
					<meta itemprop="description" content="Perform geospatial queries in Firestore based on a radius and visualize realtime updates with Angular Google Maps" />
					<meta itemprop="uploadDate" content="2018-07-10 05:59:29 -0700 -0700" />
					<meta itemprop="publisher" content="Fireship" />
				</div>
				

				

				<div class="bg-gray6 py-5 px-3 rounded-lg mb-4 flex justify-between mt-3">

					
					
					<a class="flex items-center no-underline" itemprop="author" name="Jeff Delaney" href="/contributors/jeff-delaney/">
						<img class="w-10 h-10 rounded-full block" src="/contributors/img/jeff-delaney.webp" alt="Jeff Delaney avatar">
						<span class="flex flex-col ml-2">
							<span class="no-underline">By Jeff Delaney</span>
							<span class="text-xs text-gray4">Posted <time itemprop="dateModified">Dec 11, 2019</time>
						</span>
	
					</a>

					
					<span>
						
							<a href="/tags/firebase"><span class="tag tag-firebase">#firebase</span></a>
						
							<a href="/tags/google-maps"><span class="tag tag-google-maps">#google-maps</span></a>
						
							<a href="/tags/firestore"><span class="tag tag-firestore">#firestore</span></a>
						

						
							<a class="btn btn-transparent ml-4" href="https://github.com/codediodeio/geofirex">
								Source Code
							</a>
						
					</span>
					
				
				</div>

			</header>



			
			<section class="prose dark:prose-invert max-w-full lesson-content" itemprop="articleBody">
				


				<h1 itemprop="name headline" id="realtime-geoqueries-with-firestore" class="gradient-text">
					Realtime GeoQueries with Firestore
				</h1>


				<p>The ability to query by geographic coordinates in Firestore is a highly requested feature because many successful apps - like Uber, Pokemon Go, Instagram, etc - use realtime maps as part of the core user experience. Today you will learn how to build a realtime Google map using Firestore as the data source.</p>
<p class="tip">Fingers-crossed: It's possible that Firestore will have native support for Geolcation queries in the future, but there is no public timeline for this feature that I'm aware of</p>
<h2 id="how-geohashing-works">How Geohashing Works</h2>
<p>A <a href="https://www.movable-type.co.uk/scripts/geohash.html">geohash</a> is a string that encodes a bounding box on the globe, with each character in that string being more precise. For example, a 1 character geohash is about 5,000km², while a 9 character string is about 4.77m². It works by segmenting the globe into a set of alphanumeric characters, then segments each segment by the same pattern - like a recursive function or <a href="https://fractalfoundation.org/resources/what-are-fractals/">fractal</a>.</p>
<p>Saving a geohash in Firestore is easy, but how do we query documents within <code>9qg5ux7r0</code>? This is actually quite easy. We can just paginate a query using a high unicode character of <code>~</code> because we know it will come after all other characters in the geohash.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">start</span> <span class="o">=</span> <span class="sb">`9qg5ux7r`</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">start</span> <span class="o">+</span> <span class="s1">&#39;~&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">collection</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="nx">startAt</span><span class="p">(</span><span class="nx">start</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="nx">endAt</span><span class="p">(</span><span class="nx">end</span><span class="p">)</span>
</span></span></code></pre></div><p>But unfortunately it&rsquo;s not that easy&hellip; The query above will give us everything in that geohash square, but doesn&rsquo;t take into account its neighbors. You could have points that are adjacent within 1 nanometer, but not show up in the query because they fall into a different hash.</p>
<p>In the picture below, only values that fall in the blue geohash boundary will be returned.</p>
<figure><img src="img/geohash-problem.png"
         alt="The problem with querying a single geohash"/><figcaption>
            <p>The problem with querying a single geohash</p>
        </figcaption>
</figure>

<p>But the cool thing about Firestore is that we can attach multiple realtime listeners to an app simultaneously. This might sound inefficient from a performance standpoint, but listening to data is cheap, it&rsquo;s the size of the data payload that bogs things down. Watch the video below for an in-depth overview from Frank van Puffelen (@puf) about geohashing.</p>
<div class="videoWrapper">
<iframe width="560" height="315" src="https://www.youtube.com/embed/mx1mMdHBi5Q" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div>
<h2 id="geofirex">GeoFireX</h2>
<p><a href="https://github.com/codediodeio/geofirex">GeoFireX</a> is a library born out of the challenges I encountered while building geospatial features in Firestore for a client. Some of its unique features include:</p>
<ul>
<li>Compatible with compound Firestore queries</li>
<li>Multiple query points on a single document</li>
<li>Observable-based, hot and cached to allow multiple subscribers.</li>
<li>Pipeable operators to transform return values to GeoJSON</li>
<li>Returns data sorted by distance, with extra metadata about distance and bearing.</li>
</ul>
<p>It&rsquo;s impossible to query by radius 100% server-side in Firestore (at least at the time of this article). The library determines the smallest necessary neighboring geohashes required surround the query radius and queries them. It then combines the return values into a single array and filters the remaining documents client-side.</p>
<p>Performing these calculations accurately on a sphere requires some trigonometry, but luckily there is an amazing geospatial library called <a href="http://turfjs.org/">Turf.js</a> that does all the heavy lifting. If you&rsquo;re building anything involving geolocation in JavaScript, you should have Turf in your toolkit.</p>
<p class="tip">Client-side filtering means that you might read more documents than what is actually returned by the query. Usually it's a small percentage, but depends on the distribution of points in your dataset.</p>
<p>I&rsquo;ve designed the API to match the ergonomics of Firestore as much as possible. Your typical &ldquo;geoquery&rdquo; looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">cities</span> <span class="o">=</span> <span class="nx">geo</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;cities&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">center</span> <span class="o">=</span> <span class="nx">geo</span><span class="p">.</span><span class="nx">point</span><span class="p">(</span><span class="mf">40.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">119.1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">radius</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="c1">// km
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">field</span> <span class="o">=</span> <span class="s1">&#39;position&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">cities</span><span class="p">.</span><span class="nx">within</span><span class="p">(</span><span class="nx">center</span><span class="p">,</span> <span class="nx">radius</span><span class="p">,</span> <span class="nx">field</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">query</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">// [{ ...documentData, queryMetadata: { distance: 1.23232, bearing: 45.23 }  }]
</span></span></span></code></pre></div><p>In the future, I plan on supporting additional query types, such as&hellip;</p>
<ul>
<li><code>withinPolygon</code> query within a bounding box (for example a zip code border)</li>
<li><code>closest</code> query first N closest results for faster performance/efficiency.</li>
</ul>
<h3 id="alternative-approaches">Alternative Approaches</h3>
<p>I&rsquo;d like to point out that there are several other ways you achieve your geolocation goals. Weigh the pros/cons of each and choose the one that works best for your app.</p>
<ul>
<li><a href="https://github.com/firebase/geofire">GeoFire (Realtime DB)</a></li>
<li><a href="https://github.com/MichaelSolati/geofirestore">Geofirestore</a></li>
</ul>
<p>Also look into alternatives outside of Firebase (but good luck making them realtime):</p>
<ul>
<li><a href="https://postgis.net/">PostGIS</a></li>
<li><a href="https://docs.mongodb.com/manual/geospatial-queries/">MongoDB Geospatial</a></li>
<li><a href="https://www.algolia.com/doc/guides/searching/geo-search/">Algolia Geo Search</a></li>
</ul>
<h2 id="build-a-realtime-google-map">Build a Realtime Google Map</h2>
<p>Now that you know a little bit about how geospatial data works, let&rsquo;s build a realtime geo feature with Firestore and Google maps. What we&rsquo;re building is a map this displays a marker for each point in the query. When clicked the marker will display the distance and bearing from the query centerpoint.</p>
<figure><img src="img/geoquery-firestore.gif"
         alt="Demo of geospatial query in Firestore"/><figcaption>
            <p>Demo of geospatial query in Firestore</p>
        </figcaption>
</figure>

<p class="tip">The following tutorial assumes that you have an Angular v6 app with AngularFire2 installed, and of course a Firebase project.</p>
<p>The first step is to initialize GeoFireX, which is just a wrapper for the Firebase SDK.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">npm install geofirex
</span></span></code></pre></div><p>For this demo, we will manage our data state in the component, but you could do this in an Angular service to share your query across multiple components.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="c1">// Init Firebase
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">firebase</span> <span class="kr">from</span> <span class="s1">&#39;firebase/app&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">firebase</span><span class="p">.</span><span class="nx">initializeApp</span><span class="p">(</span><span class="nx">yourConfig</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Init GeoFireX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">geofirex</span> <span class="kr">from</span> <span class="s1">&#39;geofirex&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">@Component</span><span class="p">(...)</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">MyComponent</span>  <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">geo</span> <span class="o">=</span> <span class="nx">geofirex</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">firebase</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">points</span>: <span class="kt">Observable</span><span class="p">&lt;</span><span class="nt">any</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="angular-google-maps-agm">Angular Google Maps (AGM)</h3>
<p><a href="https://angular-maps.com/">Angular Google Maps</a> (AGM) is a solid component library that makes building maps in Angular dead simple. You will need to enable Google Maps JS SDK for your Firebase project, the follow official install instructions for AGM.</p>
<p>We can build the map by declaring its components in the HTML. Notice how I am also adding a <code>trackBy</code> function to the loop of markers. This is important for realtime maps because it will prevent unchanged markers from re-rendering on each newly emitted value.</p>
<p>A special feature of GeoFireX is that we can call <code>point.queryMetadata.distance</code> to display the point&rsquo;s relative distance from the query center point, while also accounting for the <a href="https://en.wikipedia.org/wiki/Haversine_formula">curvature of the earth</a> (thanks Turf.js).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">agm-map</span> <span class="err">[</span><span class="na">latitude</span><span class="err">]=&#34;</span><span class="na">34</span><span class="err">&#34;</span> <span class="err">[</span><span class="na">longitude</span><span class="err">]=&#34;</span><span class="na">-113</span><span class="err">&#34;</span> <span class="err">[</span><span class="na">zoom</span><span class="err">]=&#34;</span><span class="na">8</span><span class="err">&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">agm-marker</span> 
</span></span><span class="line"><span class="cl">      <span class="err">*</span><span class="na">ngFor</span><span class="o">=</span><span class="s">&#34;let point of points | async; trackBy: trackByFn&#34;</span> 
</span></span><span class="line"><span class="cl">      <span class="err">[</span><span class="na">latitude</span><span class="err">]=&#34;</span><span class="na">point</span><span class="err">.</span><span class="na">position</span><span class="err">.</span><span class="na">geopoint</span><span class="err">.</span><span class="na">latitude</span><span class="err">&#34;</span> 
</span></span><span class="line"><span class="cl">      <span class="err">[</span><span class="na">longitude</span><span class="err">]=&#34;</span><span class="na">point</span><span class="err">.</span><span class="na">position</span><span class="err">.</span><span class="na">geopoint</span><span class="err">.</span><span class="na">longitude</span><span class="err">&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">agm-info-window</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>This point is {{ point.queryMetadata.distance }} kilometers from the center<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">&lt;/</span><span class="nt">agm-info-window</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">agm-marker</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">agm-map</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>Also, make sure to give it a width and height in the CSS, otherwise it will be invisible.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-css" data-lang="css"><span class="line"><span class="cl"><span class="nt">agm-map</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">height</span><span class="p">:</span> <span class="mi">100</span><span class="kt">vh</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">vw</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Here&rsquo;s what that trackBy function looks like in the component TS code:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl">  <span class="nx">trackByFn</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><h3 id="saving-geolocation-data-in-firestore">Saving Geolocation Data in Firestore</h3>
<p>Our map is all set, but we need some query-able data in our database. In GeoFireX, a point is saved to the db in the following format:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="p">[</span><span class="nx">key</span>: <span class="kt">string</span><span class="p">]</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">geohash</span>: <span class="kt">string</span><span class="p">;</span> <span class="c1">// the geohash
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">geopoint</span>: <span class="kt">GeoPoint</span> <span class="c1">// firestore.GeoPoint
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>You name the object whatever you want and save multiple points on a single document. The library provides a the <code>point</code> method to help you create this data.</p>
<p>If updating an existing doc, you can use <code>setPoint(id, lat, lng)</code> to non-destructively update the document.</p>
<p>If creating a new doc with additional data, you can use <code>setDoc(id, data)</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kd">@Component</span><span class="p">(...)</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">MyComponent</span>  <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">createPoint</span><span class="p">(</span><span class="nx">lat</span><span class="p">,</span> <span class="nx">lng</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">collection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">geo</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;places&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Use the convenience method
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">collection</span><span class="p">.</span><span class="nx">setPoint</span><span class="p">(</span><span class="s1">&#39;my-place&#39;</span><span class="p">,</span> <span class="nx">lat</span><span class="p">,</span> <span class="nx">lng</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Or be a little more explicit 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">point</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">geo</span><span class="p">.</span><span class="nx">point</span><span class="p">(</span><span class="nx">lat</span><span class="p">,</span> <span class="nx">lng</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">collection</span><span class="p">.</span><span class="nx">setDoc</span><span class="p">(</span><span class="s1">&#39;my-place&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">position</span>: <span class="kt">point.data</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Now trigger this method a few times to seed your database so we have something to query:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">button</span> <span class="err">(</span><span class="na">click</span><span class="err">)=&#34;</span><span class="na">createPoint</span><span class="err">(</span><span class="na">38</span><span class="err">,</span> <span class="na">-119</span><span class="err">)&#34;</span><span class="p">&gt;</span>Create Me<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</span></span></code></pre></div><h3 id="query-firestore-by-geographic-radius">Query Firestore by Geographic Radius</h3>
<p>Now let&rsquo;s setup a query that will run on component initialization to populate our points Observable with data. The <code>within</code> method handles this magic and takes three arguments:</p>
<ul>
<li><code>center</code> the centerpoint of the query</li>
<li><code>radius</code> the search radius in kilometers</li>
<li><code>field</code> the document field with the geopoint object, required because docs can have multiple points</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kd">@Component</span><span class="p">(...)</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">MyComponent</span>  <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">ngOnInit() {</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">collection</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">geo</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;places&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">center</span> <span class="o">=</span> <span class="nx">geo</span><span class="p">.</span><span class="nx">point</span><span class="p">(</span><span class="mi">38</span><span class="p">,</span> <span class="o">-</span><span class="mi">119</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">radius</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">field</span> <span class="o">=</span> <span class="s1">&#39;point&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">points</span> <span class="o">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">within</span><span class="p">(</span><span class="nx">center</span><span class="p">,</span> <span class="nx">radius</span><span class="p">,</span> <span class="nx">field</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">points</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p class="success">Because GeoFireX returns a hot Observable, you can subscribe multiple times without causing extra document reads that would otherwise accrue charges.</p>
<p>And that&rsquo;s it, the <code>async</code> pipe will subscribe in the html a populate your map with points. Try updating an existing point&rsquo;s position and you should see it move on the map in realtime.</p>
<h3 id="mapping-a-query-to-geojson">Mapping a Query to GeoJSON</h3>
<p>If you&rsquo;ve ever used <a href="https://blog.mapbox.com/real-time-maps-for-live-events-fad0b334e4e">MapBox</a>, you probably know that you can set up a data source in GeoJSON format. A cool thing about RxJS is that you can pipe in custom operators to transform the stream to your desired format. Because it&rsquo;s so common, I included an operator in GeoFireX that maps the array of points to a <a href="https://macwright.org/2015/03/23/geojson-second-bite.html#featurecollection">GeoJSON FeatureCollection</a>.</p>
<p>With almost no extra code, we can completely restructure our results:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">toGeoJSON</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;geofirex&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">geo</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;places&#39;</span><span class="p">).</span><span class="nx">within</span><span class="p">(...)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">this</span><span class="p">.</span><span class="nx">points</span> <span class="o">=</span> <span class="nx">query</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span> <span class="nx">toGeoJSON</span><span class="p">(</span><span class="s1">&#39;point&#39;</span><span class="p">)</span> <span class="p">)</span>
</span></span></code></pre></div><h2 id="the-end">The End</h2>
<p>My goal with GeoFireX is simply to make realtime map features as easy to build as possible in PWAs. If you have ideas for the project, please let me know on Github so we can explore them together.</p>


				
			</section>

			<section id="qna" class="my-12 flex flex-col justify-between items-center">
    <h2 class="text-2xl mb-4">Questions? Let's chat</h2>
    <a href="https://discord.gg/SpDdJ3qaKK" class="btn btn-purple btn-lg btn-glow btn-display mx-auto"><span class="w-8 mr-2"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentColor" d="M524.531,69.836a1.5,1.5,0,0,0-.764-.7A485.065,485.065,0,0,0,404.081,32.03a1.816,1.816,0,0,0-1.923.91,337.461,337.461,0,0,0-14.9,30.6,447.848,447.848,0,0,0-134.426,0,309.541,309.541,0,0,0-15.135-30.6,1.89,1.89,0,0,0-1.924-.91A483.689,483.689,0,0,0,116.085,69.137a1.712,1.712,0,0,0-.788.676C39.068,183.651,18.186,294.69,28.43,404.354a2.016,2.016,0,0,0,.765,1.375A487.666,487.666,0,0,0,176.02,479.918a1.9,1.9,0,0,0,2.063-.676A348.2,348.2,0,0,0,208.12,430.4a1.86,1.86,0,0,0-1.019-2.588,321.173,321.173,0,0,1-45.868-21.853,1.885,1.885,0,0,1-.185-3.126c3.082-2.309,6.166-4.711,9.109-7.137a1.819,1.819,0,0,1,1.9-.256c96.229,43.917,200.41,43.917,295.5,0a1.812,1.812,0,0,1,1.924.233c2.944,2.426,6.027,4.851,9.132,7.16a1.884,1.884,0,0,1-.162,3.126,301.407,301.407,0,0,1-45.89,21.83,1.875,1.875,0,0,0-1,2.611,391.055,391.055,0,0,0,30.014,48.815,1.864,1.864,0,0,0,2.063.7A486.048,486.048,0,0,0,610.7,405.729a1.882,1.882,0,0,0,.765-1.352C623.729,277.594,590.933,167.465,524.531,69.836ZM222.491,337.58c-28.972,0-52.844-26.587-52.844-59.239S193.056,219.1,222.491,219.1c29.665,0,53.306,26.82,52.843,59.239C275.334,310.993,251.924,337.58,222.491,337.58Zm195.38,0c-28.971,0-52.843-26.587-52.843-59.239S388.437,219.1,417.871,219.1c29.667,0,53.307,26.82,52.844,59.239C470.715,310.993,447.538,337.58,417.871,337.58Z"/></svg></span> Open Discord</a>
    <div class="mt-3">
        <discord-count></discord-count>
    </div>
</section>

		</article>
		
		
		<aside class="tableOfContents">
			<nav id="TableOfContents">
  <ul>
    <li><a href="#how-geohashing-works">How Geohashing Works</a></li>
    <li><a href="#geofirex">GeoFireX</a>
      <ul>
        <li><a href="#alternative-approaches">Alternative Approaches</a></li>
      </ul>
    </li>
    <li><a href="#build-a-realtime-google-map">Build a Realtime Google Map</a>
      <ul>
        <li><a href="#angular-google-maps-agm">Angular Google Maps (AGM)</a></li>
        <li><a href="#saving-geolocation-data-in-firestore">Saving Geolocation Data in Firestore</a></li>
        <li><a href="#query-firestore-by-geographic-radius">Query Firestore by Geographic Radius</a></li>
        <li><a href="#mapping-a-query-to-geojson">Mapping a Query to GeoJSON</a></li>
      </ul>
    </li>
    <li><a href="#the-end">The End</a></li>
  </ul>
</nav>
		</aside>
		
	</div>


</main>

    
<footer class="container text-center my-6 p-8 text-gray3">
    <div class="mx-auto w-24 h-1 my-12 bg-gradient-to-r from-gray5 to-gray4 rounded-full"></div>
    <div class="pt-10">Find an issue with this page? <a class="text-blue-500" href="https://github.com/fireship-io/fireship.io/tree/master/content/">Fix it on GitHub</a></div>

    <div class="py-3">
        Need help? Email <a href="mailto:henrique.castro.24@colegioplanalto.pt"><strong class="text-white font-bold">School-email</strong></a>
    </div>
    <div class="flex justify-center items-center my-2">
        <a href="https://www.youtube.com/c/Fireship"><i class="w-6 inline-block mx-2"><svg aria-hidden="true" data-prefix="fab" data-icon="youtube" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" class="svgyoutube  "><path fill="currentColor" d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z" ></path></svg></i></a>
        <a href="https://twitter.com/fireship_dev"><i class="w-6 inline-block mx-2"><svg aria-hidden="true" data-prefix="fab" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="svgtwitter  "><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z" ></path></svg></i></a>
        <a href="https://github.com/fireship-io"><i class="w-6 inline-block mx-2"><svg aria-hidden="true" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="svggithub "><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z" ></path></svg></i></a>
        <a href="https://discord.gg/SpDdJ3qaKK"><i class="w-6 inline-block mx-2"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentColor" d="M524.531,69.836a1.5,1.5,0,0,0-.764-.7A485.065,485.065,0,0,0,404.081,32.03a1.816,1.816,0,0,0-1.923.91,337.461,337.461,0,0,0-14.9,30.6,447.848,447.848,0,0,0-134.426,0,309.541,309.541,0,0,0-15.135-30.6,1.89,1.89,0,0,0-1.924-.91A483.689,483.689,0,0,0,116.085,69.137a1.712,1.712,0,0,0-.788.676C39.068,183.651,18.186,294.69,28.43,404.354a2.016,2.016,0,0,0,.765,1.375A487.666,487.666,0,0,0,176.02,479.918a1.9,1.9,0,0,0,2.063-.676A348.2,348.2,0,0,0,208.12,430.4a1.86,1.86,0,0,0-1.019-2.588,321.173,321.173,0,0,1-45.868-21.853,1.885,1.885,0,0,1-.185-3.126c3.082-2.309,6.166-4.711,9.109-7.137a1.819,1.819,0,0,1,1.9-.256c96.229,43.917,200.41,43.917,295.5,0a1.812,1.812,0,0,1,1.924.233c2.944,2.426,6.027,4.851,9.132,7.16a1.884,1.884,0,0,1-.162,3.126,301.407,301.407,0,0,1-45.89,21.83,1.875,1.875,0,0,0-1,2.611,391.055,391.055,0,0,0,30.014,48.815,1.864,1.864,0,0,0,2.063.7A486.048,486.048,0,0,0,610.7,405.729a1.882,1.882,0,0,0,.765-1.352C623.729,277.594,590.933,167.465,524.531,69.836ZM222.491,337.58c-28.972,0-52.844-26.587-52.844-59.239S193.056,219.1,222.491,219.1c29.665,0,53.306,26.82,52.843,59.239C275.334,310.993,251.924,337.58,222.491,337.58Zm195.38,0c-28.971,0-52.843-26.587-52.843-59.239S388.437,219.1,417.871,219.1c29.667,0,53.307,26.82,52.844,59.239C470.715,310.993,447.538,337.58,417.871,337.58Z"/></svg></i></a>
    </div>

    <h6>Helpful Links</h6>

    <div class="py-3">
        <a href="/courses">Activities</a> | 
        <a href="/lessons">Resources</a> | 
        <a href="/snippets">Snippets</a> | 
        <a href="/tags">Tags</a> | 
        <a href="/contributors">Contrib</a> |
        <a href="/privacy">Privacy</a> | 
        <a href="/terms">Terms</a>
    </div>

    
    <div class="text-xs">
        Copyleft 2023<br> 
    </div>

</footer>




    <app-signin></app-signin>
    <algolia-search></algolia-search>
    <hi-mom></hi-mom>

    <email-handler></email-handler>

    <route-loader>
      <div class="fixed w-full top-0 left-0 h-1 gradient-loader"></div>
    </route-loader>

    <toast-message></toast-message>
    <scroll-up></scroll-up>

    </div>

  </body>
</html>